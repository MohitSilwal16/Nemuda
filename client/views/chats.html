<!DOCTYPE html>
<div
  id="chat-body"
  class="relative flex w-screen h-screen px-10 py-5 overflow-hidden text-4xl text-white bg-gray-500 lg:text-xl bg-gradient-image"
>
  <head>
    <title>Nemuda</title>
    <script src="./static/js/htmx.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="./static/images/favico.svg" />
    <link rel="stylesheet" href="./static/css/output.css" />
    <script>
      // Function to scroll to the bottom of the message container
      function scrollToBottom(element) {
        element.scrollTop = element.scrollHeight;
      }
    </script>
  </head>

  <!-- Nav Bar -->
  <div
    class="absolute hidden w-full h-screen pr-20 mt-1 lg:h-full lg:pr-0 bg-gradient-image lg:bg-transparent lg:relative lg:w-1/3 lg:block"
    id="nav-bar"
  >
    <!-- Nemu, home & logout -->
    <div class="flex h-28 lg:h-20">
      <img
        src="../static/images/menu-bar.png"
        class="block h-20 mt-3 ml-4 mr-4 lg:hidden"
        alt=""
        id="menu"
        onclick="closeMenu()"
      />
      <div class="py-6 text-5xl cursor-pointer lg:text-2xl">Nemu</div>
      <div class="w-full"></div>
      <button
        class="px-8 m-4 text-3xl font-normal bg-blue-700 rounded-md lg:text-xl hover:bg-blue-800"
        hx-get="/home/All"
        hx-target="#chat-body"
        hx-swap="outerHTML"
        onclick="socket.close()"
        hx-push-url="/home/All"
      >
        Home
      </button>
      <button
        class="w-full px-5 m-4 text-3xl font-normal bg-blue-700 rounded-md lg:w-96 lg:text-xl hover:bg-blue-800"
        hx-delete="/login"
        hx-target="#chat-body"
        hx-swap="outerHTML"
        onclick="socket.close()"
        hx-push-url="/login"
      >
        Log Out
      </button>
    </div>

    <!-- Search Recent Chats -->
    <div class="relative mt-5 border-2 border-white rounded-xl lg:mt-0">
      <input
        type="text"
        id="search"
        name="searchPattern"
        class="w-full py-2 pl-16 mr-16 rounded-lg lg:pl-12 text-md"
        placeholder="Search"
        hx-get="/search-users"
        hx-target="#users"
        hx-trigger="input delay:500ms"
      />
      <img
        src="./static/images/search.png"
        class="absolute h-6 lg:h-5 top-4 left-3 lg:top-3 lg:left-3 cursor-text"
        onclick="search.focus()"
      />
    </div>

    <!-- Recent Chats -->
    <div
      class="mt-5 mb-32 overflow-y-auto scroll-bar h-5/6"
      id="users"
      hx-trigger="load"
      hx-get="/search-users?searchPattern="
      hx-target="#users"
    >
      {{ template "search_users.html" .}}
    </div>
  </div>
  <div class="w-10"></div>

  <!-- Message Page -->
  <div class="w-full h-full lg:w-2/3">
    <div class="h-9/10" id="message-body">
      {{ template "messaging_page.html" .}}
    </div>

    <div class="w-full h-16 bottom-1">
      <div class="relative w-full h-full">
        <!-- Textfield -->
        <form onsubmit="onMessageSend()">
          <input
            type="text"
            id="messageInput"
            readonly
            class="w-full h-24 px-2 py-4 pl-6 pr-20 text-3xl border-2 border-white lg:text-xl lg:h-full rounded-xl"
            placeholder="Enter message ..."
          />

          <!-- Send button -->
          <button
            id="send-button"
            type="submit"
            class="absolute h-8 mt-10 bottom-1 right-7 lg:h-5 lg:right-5 lg:bottom-6"
          >
            <img
              src="./static/images/send-message.png"
              alt=""
              class="h-8 bottom-5 right-5 lg:h-5 lg:right-5 lg:bottom-6"
            />
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Pop-up Alert Box -->
  <div
    class="fixed inset-0 z-50 items-center justify-center hidden text-3xl text-white bg-opacity-50 lg:text-xl"
    id="overlay"
  >
    <div class="max-w-sm p-6 mx-auto bg-blue-600 rounded-lg shadow-lg">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-white" id="alertTitle">Alert</h2>
      </div>
      <p class="mt-4 text-white" id="alertBody">This is an alert box</p>
      <div class="flex justify-end mt-6">
        <button
          class="px-4 py-2 text-white bg-black rounded focus:outline-none"
          onclick="closeAlert()"
        >
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Pop-up -->
  <div
    class="fixed z-50 flex-col hidden max-w-sm p-6 mx-auto text-xl text-white bg-blue-600 rounded-lg shadow-lg cursor-pointer bottom-26 right-10 w-80"
    id="notification"
  >
    <div class="flex items-center justify-between">
      <h2 class="font-semibold text-white" id="notificationTitle">
        Notification Title
      </h2>
    </div>
    <p class="mt-4 text-white" id="notificationBody">
      This is the notification body.
    </p>
    <div class="flex justify-around mt-6">
      <button
        class="px-4 py-2 font-medium text-white bg-black rounded-lg focus:outline-none"
        onclick="onClickNotification()"
      >
        Open
      </button>
      <button
        class="px-4 py-2 font-medium text-white bg-black rounded-lg focus:outline-none"
        onclick="closeNotification()"
      >
        Close
      </button>
    </div>
  </div>

  <!-- Notification Audio Sound -->
  <audio src="./static/audio/notification.mp3" id="notificationSound"></audio>

  <script>
    try {
      let sessionToken = getSessionToken();
      var socket = new WebSocket(
        // "ws://127.0.0.1:3000/ws/chat/" + sessionToken
        "ws://nemuda.hopto.org:3000/ws/chat/" + sessionToken
      );
    } catch (e) {
      openAlert("WebSocket not Connected", "Try Refresing Browser");
    }

    socket.addEventListener("open", function (event) {
      console.log("WebSocket Connected");
    });

    socket.addEventListener("close", function (event) {
      console.log("WebSocket Disconnected");
      try {
        openAlert("WebSocket Disconnected", "Try Refreshing Browser");
      } catch (e) {}
    });

    // Listen for messages
    socket.addEventListener("message", function (event) {
      const responseData = JSON.parse(event.data);
      const titleUser = document.getElementById("title").innerText;

      if (responseData.error) {
        if (responseData.error == "Invalid Session Token") {
          socket.close();
          location.href = "login";
        } else {
          openAlert("Error", responseData.error);
        }
        return;
      }

      if (responseData.messageType == "Read") {
        if (responseData.sender == titleUser) {
          let messagesStatus =
            document.getElementsByClassName("message-status");

          for (let i = messagesStatus.length - 1; i >= 0; --i) {
            if (messagesStatus[i].innerHTML == "Read") {
              break;
            }
            messagesStatus[i].innerHTML = "Read";
          }
        }
        return;
      }

      if (responseData.messageType == "Delivered") {
        if (responseData.sender == titleUser) {
          let messagesStatus =
            document.getElementsByClassName("message-status");

          for (let i = messagesStatus.length - 1; i >= 0; --i) {
            if (
              messagesStatus[i].innerText == "Read" ||
              messagesStatus[i].innerText == "Delivered"
            ) {
              break;
            }
            messagesStatus[i].innerHTML = "Delivered";
          }
        }
        // Update msg status in search chat cards
        let searchUserCard = document.getElementById(
          "search-user-" + responseData.sender
        );

        if (searchUserCard) {
          let statusElement = document.getElementById(
            "search-msg-status-" + responseData.sender
          );

          if (
            statusElement.innerText == "Sent" &&
            !statusElement.classList.contains("hidden")
          ) {
            statusElement.innerText = "Delivered";
          }
        }
        return;
      }

      // There's no err message so continue
      // Send message in alert pop up if receiver hasn't open sender's chat
      if (
        titleUser != responseData.sender &&
        !responseData.selfMessage &&
        responseData.messageContent != ""
      ) {
        openNotification(responseData.sender, responseData.messageContent);
        return;
      }

      // If it's self message then no need to mark it as read
      if (!responseData.selfMessage) {
        markMessageAsRead(responseData.sender);
      }

      const messagesContainer = document.getElementById("messages");
      const messageCard = createMessageCard(responseData);
      messagesContainer.appendChild(messageCard);

      let noMsgBox = document.getElementById("noMsgBox");

      if (noMsgBox) {
        noMsgBox.remove();
      }

      // Scroll to the bottom after adding the new message
      scrollToBottom(document.getElementById("message-scroll"));
    });

    // Send a message to the server
    function onMessageSend() {
      event.preventDefault();
      const messageInput = document.getElementById("messageInput");
      const message = messageInput.value.trim();

      if (message == "") {
        openAlert("Empty Message", "Message is Empty");
        return;
      }

      if (message.length > 100) {
        openAlert(
          "Message Limit Exceeded",
          "Message should be less than 100 characters"
        );
        return;
      }
      const jsonData = {
        messageType: "Message",
        message: message,
        receiver: document.getElementById("title").innerText,
        sessionToken: getSessionToken(),
      };

      socket.send(JSON.stringify(jsonData));
      messageInput.value = "";
    }

    function markMessageAsRead(receiver) {
      const jsonData = {
        messageType: "Read",
        receiver: receiver,
        sessionToken: getSessionToken(),
      };

      socket.send(JSON.stringify(jsonData));
    }

    function getSessionToken() {
      const cookies = document.cookie.split(";"); // Split cookies into an array
      let sessionToken = null;

      cookies.forEach((cookie) => {
        const cookiePair = cookie.split("=");
        const cookieName = cookiePair[0].trim(); // Cookie name
        const cookieValue = cookiePair[1]; // Cookie value

        // Check if the cookie name matches 'sessionToken'
        if (cookieName === "sessionToken") {
          sessionToken = cookieValue; // Assign sessionToken value
        }
      });
      return sessionToken;
    }

    function createMessageCard(responseData) {
      // Create the main container div
      const messageContainer = document.createElement("div");
      messageContainer.classList.add("flex", "mb-4", "text-2xl", "lg:text-lg");

      // Create the inner message bubble div
      const messageBubble = document.createElement("div");
      messageBubble.classList.add(
        "p-3",
        "rounded-lg",
        "bg-blue-600",
        "text-white"
      );

      // Create the date-time element
      const dateTimeElement = document.createElement("div");
      dateTimeElement.classList.add("flex", "justify-between", "items-center");
      const dateTimeSpan = document.createElement("span");
      dateTimeSpan.classList.add("lg:text-sm", "text-lg");
      dateTimeSpan.innerHTML = responseData.dateTime;
      dateTimeElement.appendChild(dateTimeSpan);

      // Create the message content element
      const messageContent = document.createElement("p");
      messageContent.classList.add("mt-1", "font-semibold");
      messageContent.innerHTML = responseData.messageContent;

      // Create the status element
      const statusElement = document.createElement("div");
      statusElement.classList.add(
        "mt-1",
        "text-right",
        "text-gray-300",
        "text-lg",
        "lg:text-xs",
        "message-status"
      );
      statusElement.innerHTML = responseData.status;

      // Append elements to message bubble
      messageBubble.appendChild(dateTimeElement);
      messageBubble.appendChild(messageContent);

      // Conditionally append the status element and adjust container style
      if (responseData.selfMessage) {
        messageContainer.classList.add("justify-end");
        messageBubble.classList.add("max-w-md");
        messageBubble.appendChild(statusElement);
      } else {
        messageContainer.classList.add("justify-start");
        messageBubble.classList.add("max-w-xs");
      }

      // Append the message bubble to the main container
      messageContainer.appendChild(messageBubble);

      return messageContainer;
    }

    function openAlert(title, body) {
      document.getElementById("overlay").style.display = "flex";
      document.getElementById("alertTitle").innerHTML = title;
      document.getElementById("alertBody").innerHTML = body;
    }

    function closeAlert() {
      document.getElementById("overlay").style.display = "none";
    }

    function openNotification(title, body) {
      document.getElementById("notificationTitle").innerText = title;
      document.getElementById("notificationBody").innerText = body;

      let notification = document.getElementById("notification");
      notification.style.display = "flex";

      document.getElementById("notificationSound").play();
    }

    function onClickNotification() {
      const receiver = document.getElementById("notificationTitle").innerText;
      const title = document.getElementById("title").innerText;

      if (title == receiver) {
        closeNotification();
        return;
      }

      fetch("/message/" + receiver + "?offset=0")
        .then((response) => response.text())
        .then((html) => {
          document.getElementById("message-body").innerHTML = html;

          closeNotification();

          const msgInput = document.getElementById("messageInput");
          msgInput.removeAttribute("readonly");

          msgInput.focus();
          scrollToBottom(document.getElementById("message-scroll"));
          markMessageAsRead(receiver);

          // Re-initialize HTMX on the new content
          htmx.process(document.getElementById("message-body"));
        })
        .catch((error) => {
          alert("Internal Server Error");
        });
    }

    function closeNotification() {
      document.getElementById("notification").style.display = "none";
    }

    // Called when username card is clicked
    function onUserClick(username) {
      document.getElementById("messageInput").removeAttribute("readonly");
      messageInput.focus();
      markMessageAsRead(username);
      closeMenu();
    }

    // Close socket when back button is pressed
    window.addEventListener("popstate", function (event) {
      socket.close();
    });

    function openMenu() {
      let navBar = document.getElementById("nav-bar");

      if (navBar.classList.contains("hidden")) {
        navBar.classList.remove("hidden");
      }

      let messageInput = document.getElementById("messageInput");
      let sendButton = document.getElementById("send-button");
      if (
        messageInput.classList.contains("hidden") &&
        sendButton.classList.contains("hidden")
      ) {
        return;
      }
      messageInput.classList.add("hidden");
      sendButton.classList.add("hidden");
    }
    function closeMenu() {
      let navBar = document.getElementById("nav-bar");
      if (!navBar.classList.contains("hidden")) {
        navBar.classList.add("hidden");
      }

      let messageInput = document.getElementById("messageInput");
      let sendButton = document.getElementById("send-button");
      if (
        messageInput.classList.contains("hidden") &&
        sendButton.classList.contains("hidden")
      ) {
        messageInput.classList.remove("hidden");
        sendButton.classList.remove("hidden");
      }
    }
  </script>
</div>
