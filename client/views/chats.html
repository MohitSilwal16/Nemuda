<!DOCTYPE html>
<div
  id="chat-body"
  class="flex w-screen h-screen px-10 py-5 overflow-hidden text-white bg-gray-500 bg-gradient-image"
>
  <head>
    <title>Nemuda</title>
    <script src="./static/js/htmx.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="../../static/images/favico.svg"
    />

    <link rel="stylesheet" href="./static/css/output.css" />
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
  </head>

  <!-- Recent Chats & Search -->
  <div class="w-1/3 mt-1">
    <!-- Nemu, home & logout -->
    <div class="flex">
      <div class="py-6 text-2xl cursor-pointer">Nemu</div>
      <div class="w-full"></div>
      <button
        class="px-8 m-4 text-xl font-normal bg-blue-700 rounded-md hover:bg-blue-800"
        hx-get="/blogs/All?offset=0"
        hx-target="#chat-body"
        hx-swap="outerHTML"
        onclick="socket.close()"
      >
        Home
      </button>
      <button
        class="px-5 m-4 text-xl font-normal bg-blue-700 rounded-md w-96 hover:bg-blue-800"
        hx-delete="/login"
        hx-target="#chat-body"
        hx-swap="outerHTML"
        onclick="socket.close()"
      >
        Log Out
      </button>
    </div>

    <!-- Search Recent Chats -->
    <div class="relative border-2 border-white rounded-xl">
      <input
        type="text"
        id="search"
        name="searchPattern"
        class="w-full py-2 pl-12 rounded-lg text-md"
        placeholder="Search"
        hx-get="/search-users"
        hx-target="#users"
        hx-trigger="input delay:500ms"
      />
      <img
        src="./static/images/search.png"
        class="absolute h-5 top-2.5 left-3 cursor-text"
        onclick="search.focus()"
      />
    </div>

    <!-- Recent Chats -->
    <div
      class="mt-5 mb-32 overflow-y-auto scroll-bar h-5/6"
      id="users"
      hx-trigger="load"
      hx-get="/search-users?searchPattern="
      hx-target="#users"
    >
      {{ template "search_users.html" .}}
    </div>
  </div>
  <div class="w-10"></div>

  <!-- Message Page -->
  <div class="w-2/3">
    <div class="h-9/10" id="message-body">
      {{ template "messaging_page.html" .}}
    </div>

    <div class="w-full h-16 bottom-1">
      <div class="relative w-full h-full">
        <!-- Textfield -->
        <form id="form">
          <input
            readonly
            type="text"
            name="message"
            id="messageInput"
            class="w-full h-full px-2 py-4 text-xl border-2 border-white rounded-xl"
            placeholder="Enter message ..."
          />

          <!-- Send button -->
          <button type="submit" class="absolute h-5 right-5 bottom-6">
            <img
              src="./static/images/send-message.png"
              alt=""
              class="h-5 right-5 bottom-6"
            />
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Pop-up Alert Box -->
  <div
    class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-50"
    id="overlay"
  >
    <div class="max-w-sm p-6 mx-auto bg-white rounded-lg shadow-lg">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-800" id="alertTitle">
          Alert
        </h2>
      </div>
      <p class="mt-4 text-gray-600" id="alertBody">This is an alert box</p>
      <div class="flex justify-end mt-6">
        <button
          class="px-4 py-2 text-white bg-blue-600 rounded hover:bg-blue-700 focus:outline-none"
          onclick="closeAlert()"
        >
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Pop-up -->
  <div
    class="fixed z-50 flex-col hidden max-w-sm p-6 mx-auto text-white bg-blue-600 rounded-lg shadow-lg cursor-pointer bottom-26 right-10 w-80"
    id="notification"
  >
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold text-white" id="notificationTitle">
        Notification Title
      </h2>
    </div>
    <p class="mt-4 text-white" id="notificationBody">
      This is the notification body.
    </p>
    <div class="flex justify-around mt-6">
      <button
        class="px-4 py-2 font-medium text-white bg-black rounded-lg focus:outline-none"
        onclick="onclickNotification()"
      >
        Open
      </button>
      <button
        class="px-4 py-2 font-medium text-white bg-black rounded-lg focus:outline-none"
        onclick="closeNotification()"
      >
        Close
      </button>
    </div>
  </div>

  <script>
    function clearMessageField() {
      document.getElementById("message").value = "";
    }

    var socket = new WebSocket("ws://localhost:3000/ws/chat");

    socket.addEventListener("open", function (event) {
      console.log("WebSocket Connected");
    });

    socket.addEventListener("close", function (event) {
      console.log("WebSocket Disconnected");
    });

    // Listen for messages
    socket.addEventListener("message", function (event) {
      const responseData = JSON.parse(event.data);
      const receiver = document.getElementById("title").innerText;

      // Send message in alert pop up if receiver hasn't open sender's chat
      if (receiver != responseData.sender && !responseData.selfMessage) {
        openNotification(responseData.sender, responseData.messageContent);
        return;
      }

      const messagesDiv = document.getElementById("messages");
      const messageElement = document.createElement("p");

      messageElement.textContent =
        responseData.sender +
        ": " +
        responseData.messageContent +
        ' "' +
        responseData.dateTime +
        '"' +
        responseData.status;

      if (responseData.selfMessage) {
        messageElement.classList.add("text-right");
      }

      messagesDiv.appendChild(messageElement);
    });

    // Send a message to the server
    document.getElementById("form").addEventListener("submit", function () {
      event.preventDefault();
      const messageInput = document.getElementById("messageInput");
      const message = messageInput.value;

      const jsonData = {
        message: message,
        receiver: document.getElementById("title").innerText,
      };

      socket.send(JSON.stringify(jsonData));
      messageInput.value = "";
    });

    function openAlert(title, body) {
      document.getElementById("overlay").style.display = "flex";
      document.getElementById("alertTitle").innerHTML = title;
      document.getElementById("alertBody").innerHTML = body;
    }

    function closeAlert() {
      document.getElementById("overlay").style.display = "none";
    }

    function openNotification(title, body) {
      document.getElementById("notificationTitle").innerText = title;
      document.getElementById("notificationBody").innerText = body;

      let notification = document.getElementById("notification");
      notification.style.display = "flex";
    }

    function onclickNotification() {
      const title = document.getElementById("notificationTitle").innerText;

      fetch("/message/" + title)
        .then((response) => response.text())
        .then((html) => {
          document.getElementById("message-body").innerHTML = html;
          closeNotification();
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });

      const msgInput = document.getElementById("messageInput");
      msgInput.removeAttribute("readonly");
      msgInput.focus();
    }

    function closeNotification() {
      document.getElementById("notification").style.display = "none";
    }

    // Called when username card is clicked
    function onUserClick() {
      messageInput.focus();
      document.getElementById("messageInput").removeAttribute("readonly");
    }
  </script>
</div>
